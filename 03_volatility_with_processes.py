# -*- coding: utf-8 -*-


# –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏:
#
# –ü—Ä–∏ —Ç–æ—Ä–≥–∞—Ö –Ω–∞ –±–∏—Ä–∂–µ —Å–æ–≤–µ—Ä—à–∞—é—Ç—Å—è —Å–¥–µ–ª–∫–∏ - –æ–¥–∏–Ω –∫—É–ø–∏–ª, –≤—Ç–æ—Ä–æ–π –ø—Ä–æ–¥–∞–ª.
# –ü–æ–∫—É–ø–∞—é—Ç –∏ –ø—Ä–æ–¥–∞—é—Ç —Ü–µ–Ω–Ω—ã–µ –±—É–º–∞–≥–∏ (–∞–∫—Ü–∏–∏, –æ–±–ª–∏–≥–∞—Ü–∏–∏, —Ñ—å—é—á–µ—Ä—Å—ã, –µ—Ç—Å). –¶–µ–Ω–Ω—ã–µ –±—É–º–∞–≥–∏ - —ç—Ç–æ –ø–æ —Å—É—Ç–∏ –¥–æ–ª–≥–æ–≤—ã–µ —Ä–∞—Å–ø–∏—Å–∫–∏.
# –¶–µ–Ω–Ω—ã–µ –±—É–º–∞–≥–∏ –≤—ã–ø—É—Å–∫–∞—é—Ç—Å—è –ø–∞—Ä—Ç–∏—è–º–∏, –æ—Ç –¥–µ—Å—è—Ç–∫–∞ –¥–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–ª–ª–∏–æ–Ω–æ–≤ —à—Ç—É–∫.
# –ö–∞–∂–¥–∞—è —Ç–∞–∫–∞—è –ø–∞—Ä—Ç–∏—è (–≤—ã–ø—É—Å–∫) –∏–º–µ–µ—Ç —Å–≤–æ–π —Ç–æ—Ä–≥–æ–≤—ã–π –∫–æ–¥ –Ω–∞ –±–∏—Ä–∂–µ - —Ç–∏–∫–µ—Ä - https://goo.gl/MJQ5Lq
# –í—Å–µ –±—É–º–∞–≥–∏ –∏–∑ —ç—Ç–æ–π –ø–∞—Ä—Ç–∏–∏ (–≤—ã–ø—É—Å–∫–∞) –æ–¥–∏–Ω–∞–∫–æ–≤—ã –≤ —Ü–µ–Ω–µ, –ø–æ—ç—Ç–æ–º—É –≥–æ–≤–æ—Ä—è—Ç –æ —Ü–µ–Ω–µ –æ–¥–Ω–æ–π –±—É–º–∞–≥–∏.
# –£ —Ä–∞–∑–Ω—ã—Ö –≤—ã–ø—É—Å–∫–æ–≤ –±—É–º–∞–≥ - —Ä–∞–∑–Ω—ã–µ —Ü–µ–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –≤ —Å–æ—Ç–Ω–∏ –∏ —Ç—ã—Å—è—á–∏ —Ä–∞–∑.
# –ö–∞–∂–¥–∞—è –±–∏—Ä–∂–µ–≤–∞—è —Å–¥–µ–ª–∫–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏–∑—É–µ—Ç—Å—è:
#   —Ç–∏–∫–µ—Ä —Ü–µ–Ω–Ω–Ω–æ–π –±—É–º–∞–≥–∏
#   –≤—Ä–µ–º—è —Å–¥–µ–ª–∫–∏
#   —Ü–µ–Ω–∞ —Å–¥–µ–ª–∫–∏
#   –æ–±—å–µ–º —Å–¥–µ–ª–∫–∏ (—Å–∫–æ–ª—å–∫–æ —Ü–µ–Ω–Ω—ã—Ö –±—É–º–∞–≥ –±—ã–ª–æ –∫—É–ø–ª–µ–Ω–æ)
#
# –í —Ö–æ–¥–µ —Ç–æ—Ä–≥–æ–≤ —Ü–µ–Ω—ã —Å–¥–µ–ª–æ–∫ –º–æ–≥—É—Ç —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º —Ä–∞—Å—Ç–∏ –∏ –ø–æ–Ω–∏–∂–∞—Ç—å—Å—è. –í–µ–ª–∏—á–∏–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω –Ω–∞–∑—ã–≤–∞—Ç–µ—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å—é.
# –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –±—É–º–∞–≥–∞ ‚Ññ1 —Ç–æ—Ä–≥–æ–≤–∞–ª–∞—Å—å —Å —Ü–µ–Ω–∞–º–∏ 11, 11, 12, 11, 12, 11, 11, 11 - —Ç–æ –æ–Ω–∞ –º–∞–ª–æ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–∞.
# –ê –µ—Å–ª–∏ —É –±—É–º–∞–≥–∏ ‚Ññ2 —Ü–µ–Ω—ã —Å–¥–µ–ª–æ–∫ –±—ã–ª–∏: 20, 15, 23, 56, 100, 50, 3, 10 - —Ç–æ —Ç–∞–∫–∞—è –±—É–º–∞–≥–∞ –∏–º–µ–µ—Ç –±–æ–ª—å—à—É—é –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å.
# –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å –º–æ–∂–Ω–æ —Å—á–∏—Ç–∞—Ç—å —Ä–∞–∑–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏, –º—ã –±—É–¥–µ–º —Å—á–∏—Ç–∞—Ç—å —Å–∏–ª—å–Ω–æ —É–ø—Ä–æ—â–µ–Ω–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º -
# –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –æ—Ç –ø–æ–ª—É—Å—É–º–º—ã –∫—Ä–∞–π–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π —Ü–µ–Ω—ã –∑–∞ —Ç–æ—Ä–≥–æ–≤—É—é —Å–µ—Å—Å–∏—é:
#   –ø–æ–ª—É—Å—É–º–º–∞ = (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ + –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞) / 2
#   –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å = ((–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ - –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞) / –ø–æ–ª—É—Å—É–º–º–∞) * 100%
# –ù–∞–ø—Ä–∏–º–µ—Ä –¥–ª—è –±—É–º–∞–≥–∏ ‚Ññ1:
#   half_sum = (12 + 11) / 2 = 11.5
#   volatility = ((12 - 11) / half_sum) * 100 = 8.7%
# –î–ª—è –±—É–º–∞–≥–∏ ‚Ññ2:
#   half_sum = (100 + 3) / 2 = 51.5
#   volatility = ((100 - 3) / half_sum) * 100 = 188.34%
#
# –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–∞–∫: https://goo.gl/VJNmmY
#
# –ó–∞–¥–∞—á–∞: –≤—ã—á–∏—Å–ª–∏—Ç—å 3 —Ç–∏–∫–µ—Ä–∞ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –∏ 3 —Ç–∏–∫–µ—Ä–∞ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å—é.
# –ë—É–º–∞–≥–∏ —Å –Ω—É–ª–µ–≤–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å—é –≤—ã–≤–µ—Å—Ç–∏ –æ—Ç–¥–µ–ª—å–Ω–æ.
# –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã–≤–µ—Å—Ç–∏ –Ω–∞ –∫–æ–Ω—Å–æ–ª—å –≤ –≤–∏–¥–µ:
#   –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å:
#       –¢–ò–ö–ï–†1 - –•–•–•.–•–• %
#       –¢–ò–ö–ï–†2 - –•–•–•.–•–• %
#       –¢–ò–ö–ï–†3 - –•–•–•.–•–• %
#   –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å:
#       –¢–ò–ö–ï–†4 - –•–•–•.–•–• %
#       –¢–ò–ö–ï–†5 - –•–•–•.–•–• %
#       –¢–ò–ö–ï–†6 - –•–•–•.–•–• %
#   –ù—É–ª–µ–≤–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å:
#       –¢–ò–ö–ï–†7, –¢–ò–ö–ï–†8, –¢–ò–ö–ï–†9, –¢–ò–ö–ï–†10, –¢–ò–ö–ï–†11, –¢–ò–ö–ï–†12
# –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ —É–∫–∞–∑—ã–≤–∞—Ç—å –≤ –ø–æ—Ä—è–¥–∫–µ —É–±—ã–≤–∞–Ω–∏—è. –¢–∏–∫–µ—Ä—ã —Å –Ω—É–ª–µ–≤–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å—é —É–ø–æ—Ä—è–¥–æ—á–∏—Ç—å –ø–æ –∏–º–µ–Ω–∏.
#
# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
# 1. –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª https://drive.google.com/file/d/1l5sia-9c-t91iIPiGyBc1s9mQ8RgTNqb/view?usp=sharing
#       (–æ–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –∑–Ω–∞—á–æ–∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É,
#       —Å–º https://drive.google.com/file/d/1M6mW1jI2RdZhdSCEmlbFi5eoAXOR3u6G/view?usp=sharing)
# 2. –†–∞–∑–∑–∏–ø–æ–≤–∞—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞—Ä—Ö–∏–≤–∞
#       –≤ –ø–∞–ø–∫—É python_base/lesson_012/trades
# 3. –í –∫–∞–∂–¥–æ–º —Ñ–∞–π–ª–µ –≤ –ø–∞–ø–∫–µ trades —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –ø–æ —Å–¥–µ–ª–∞–∫–∞–º –ø–æ –æ–¥–Ω–æ–º—É —Ç–∏–∫–µ—Ä—É, —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—è—Ç—ã–º–∏.
#   –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ - –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫:
#       SECID - —Ç–∏–∫–µ—Ä
#       TRADETIME - –≤—Ä–µ–º—è —Å–¥–µ–ª–∫–∏
#       PRICE - —Ü–µ–Ω–∞ —Å–¥–µ–ª–∫–∏
#       QUANTITY - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—É–º–∞–≥ –≤ —ç—Ç–æ–π —Å–¥–µ–ª–∫–µ
#   –í—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏ –≤ —Ñ–∞–π–ª–µ - –¥–∞–Ω–Ω—ã–µ –æ —Å–¥–µ–ª–∫–∞—Ö
#
# –ü–æ–¥—Å–∫–∞–∑–∫–∞: –Ω—É–∂–Ω–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª, –≤—ã—á–∏—Ç—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ, –≤—ã—Å—á–∏—Ç—ã–≤–∞—Ç—å –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å –∏ –∑–∞–ø–æ–º–∏–Ω–∞—Ç—å.
# –í—ã–≤–æ–¥ –Ω–∞ –∫–æ–Ω—Å–æ–ª—å –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤.
#
# –î–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –º—É–ª—å—Ç–∏–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏, –∫–æ–¥ –æ—Ñ–æ—Ä–º–∏—Ç—å –≤ –æ–±—å–µ–∫—Ç–Ω–æ–º —Å—Ç–∏–ª–µ, –∏—Å–ø–æ–ª—å–∑—É—è —Å–ª–µ–¥—É—é—â–∏–π –∫–∞—Ä–∫–∞—Å
#
# class <–ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞>:
#
#     def __init__(self, <–ø–∞—Ä–∞–º–µ—Ç—Ä—ã>):
#         <—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤>
#
#     def run(self):
#         <–æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö>
import os
import time
from collections import OrderedDict
import multiprocessing
from queue import Empty
import importlib

simple_volatility = importlib.import_module('01_volatility')


class TickerVolatility(multiprocessing.Process, simple_volatility.TickerVolatility):

    def __init__(self, filename, queue, lock, zero_queue, *args, **kwargs):
        super(TickerVolatility, self).__init__(*args, **kwargs)
        self.filename = filename
        self.queue = queue
        self.zero_queue = zero_queue
        self.dlock = lock

    def run(self):
        simple_volatility.TickerVolatility.run(self)

    def act(self):
        if self.volatility == 0:
            print('–∫–ª–∞–¥—É –≤ –æ—á–µ—Ä–µ–¥—å', self.row_dict['SECID'], flush=True)
            self.zero_queue.put(self.row_dict['SECID'])
        else:
            self.queue.put([self.row_dict['SECID'], self.volatility])
            print('–∫–ª–∞–¥—É –≤ –æ—á–µ—Ä–µ–¥—å', self.row_dict['SECID'], self.volatility, flush=True)


class Collector:

    def __init__(self, tickers, lock, *args, **kwargs):
        super(Collector, self).__init__(*args, **kwargs)
        self.tickers = tickers
        self.queue = multiprocessing.Queue()
        self.zero_queue = multiprocessing.Queue()
        self.collector_volatilities_dict = OrderedDict()
        self.collector_zero_volatilities = []
        self.lock = lock
        self.ticker_proc_list = []

    def sort_volatility_dict(self, dict, n=3, reverse=False):
        i = 0
        d = OrderedDict()
        sorted_dict = OrderedDict(sorted(dict.items(), key=lambda k: k[1], reverse=reverse))
        for ticket, value in sorted_dict.items():
            if i == n:
                break
            d[ticket] = value
            i += 1
        return d

    def run(self):
        for ticker in self.tickers:
            ticker_proc = TickerVolatility(filename=ticker, queue=self.queue, lock=self.lock,
                                           zero_queue=self.zero_queue)
            self.ticker_proc_list.append(ticker_proc)
        for proc in self.ticker_proc_list:
            proc.start()
        while True:
            try:
                receiver = self.queue.get(timeout=1)
                print('–≤—ã—Ç–∞—Å–∫–∏–≤–∞—é –∏–∑ –æ—á–µ—Ä–µ–¥–∏', receiver, flush=True)
                self.collector_volatilities_dict[receiver[0]] = receiver[1]
            except Empty:
                if not any(ticker.is_alive() for ticker in self.ticker_proc_list):
                    break
        while True:
            try:
                zero_receiver = self.zero_queue.get(timeout=1)
                print('–≤—ã—Ç–∞—Å–∫–∏–≤–∞—é –∏–∑ –æ—á–µ—Ä–µ–¥–∏', zero_receiver, flush=True)
                self.collector_zero_volatilities.append(zero_receiver)
            except Empty:
                if not any(ticker.is_alive() for ticker in self.ticker_proc_list):
                    break

        max_dict = self.sort_volatility_dict(dict=self.collector_volatilities_dict, n=3, reverse=True)
        min_dict = self.sort_volatility_dict(dict=self.collector_volatilities_dict, n=3, reverse=False)
        self.collector_zero_volatilities.sort()

        print(len(self.collector_volatilities_dict))
        print('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å:')
        for ticket, value in max_dict.items():
            print('\t', ticket, round(value, 2), '%')

        print('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å:')
        for ticket, value in reversed(min_dict.items()):
            print('\t', ticket, round(value, 2), '%')

        print('–ù—É–ª–µ–≤–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å:', end='\n\t')
        for ticket in self.collector_zero_volatilities:
            print(ticket, end=', ')

        for proc in self.ticker_proc_list:
            proc.join()


if __name__ == '__main__':
    start = time.time()
    path = 'trades'
    counters = []
    lock = multiprocessing.Lock()

    if not os.access(path, os.F_OK):
        raise BaseException('–¢–∞–∫–æ–π –ø–∞–ø–∫–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç')
    files = os.walk(path)

    for dirpath, dirnames, filenames in os.walk(path):
        for file in filenames:
            counters.append(os.path.join(dirpath, file))

    collector = Collector(tickers=counters, lock=lock)
    collector.run()

    print(time.time() - start)

# –∑–∞—á—ë—Ç! üöÄ
